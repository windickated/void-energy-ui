---
import THEME_REGISTRY from '../config/void-registry.json';
---

<script is:inline define:vars={{ registry: THEME_REGISTRY }}>
  (function () {
    try {
      var root = document.documentElement;
      var localAtmosphere = localStorage.getItem('void_atmosphere');
      var localConfig = localStorage.getItem('void_user_config');

      // 1. Validate Atmosphere against the Registry
      // If the user has a saved theme that you deleted, this falls back safely.
      var activeAtmosphere = 'void';
      if (localAtmosphere && registry[localAtmosphere]) {
        activeAtmosphere = localAtmosphere;
      }

      // 2. Lookup Physics (The Triad)
      // This allows "retro" themes to load instant-motion CSS before the body paints.
      var themeData = registry[activeAtmosphere];

      // 3. Inject Attributes
      root.setAttribute('data-atmosphere', activeAtmosphere);
      root.setAttribute('data-physics', themeData.physics);
      root.setAttribute('data-mode', themeData.mode);

      // 4. Restore User Preferences
      if (localConfig) {
        var config = JSON.parse(localConfig);
        if (config.scale) root.style.setProperty('--text-scale', config.scale);
        if (config.density) {
          // Re-map density labels to numbers locally for speed
          var densities = { high: 0.75, standard: 1, low: 1.25 };
          root.style.setProperty('--density', densities[config.density] || 1);
        }
        if (config.fontHeading)
          root.style.setProperty('--user-font-heading', config.fontHeading);
        if (config.fontBody)
          root.style.setProperty('--user-font-body', config.fontBody);
      }
    } catch (e) {
      console.warn('Void Hydration Error:', e);
    }
  })();
</script>
