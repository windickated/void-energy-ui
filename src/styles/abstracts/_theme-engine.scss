/*
 * ROLE: Theme emitter.
 * RESPONSIBILITY: Merge palette maps with Physics presets to produce CSS variables for each atmosphere selector.
 */

@use 'sass:map';
@use './variables' as *;
@use './physics-presets';

// Combines palette + physics into a single theme and emits CSS variables.
@mixin generate-theme($name, $config) {
  $physics-name: map.get($config, 'physics');
  $physics-map: map.get(physics-presets.$physics-presets, $physics-name);

  // Fallback check
  @if $physics-map == null {
    @warn "Physics preset `#{$physics-name}` not found for `#{$name}`. Falling back to `glass`.";
    $physics-name: 'glass';
    $physics-map: map.get(physics-presets.$physics-presets, 'glass');
  }

  $palette: map.get($config, 'palette');

  @if $palette == null {
    @warn "No palette provided for theme `#{$name}`. Only physics variables will be set.";
    $palette: ();
  }

  // Check if the theme explicitly defines a custom density map.
  $theme-density: map.get($config, 'density');

  // If no custom density is provided, use the global default from _variables.scss
  @if $theme-density == null {
    $theme-density: $spacing-scale;
  }

  // CALCULATED VALUES (Automation)
  // We still calculate speed-fast automatically based on the preset's speed-base
  $speed-base: map.get($physics-map, 'speed-base');
  $speed-fast: if($speed-base == 0s, 0s, $speed-base * 0.66);

  $calculated-vars: (
    'speed-fast': $speed-fast,
  );

  // MERGE: Physics Preset + Calculated Vars + Color Palette
  // We NO LONGER overwrite ease-snap/stabilize with ease-base.
  // We trust the preset.
  $theme-map: map.merge(map.merge($physics-map, $calculated-vars), $palette);

  $selector: if($name == 'default', ':root', "[data-atmosphere='#{$name}']");
  $physics-selector: "#{$selector}[data-physics='#{$physics-name}']";

  #{$selector},
  #{$physics-selector} {
    color-scheme: if(map.get($config, 'type') == 'light', light, dark);

    @each $key, $value in $theme-map {
      --#{$key}: #{$value};
    }

    @each $key, $value in $theme-density {
      --space-#{$key}: #{$value};
    }
  }
}
