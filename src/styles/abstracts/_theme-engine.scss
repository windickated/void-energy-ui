@use 'sass:map';
@use './variables' as *;
@use './physics-presets';

// Combines palette + physics into a single theme and emits CSS variables.
@mixin generate-theme($name, $config) {
  $physics-name: map.get($config, 'physics');
  $physics-map: map.get(physics-presets.$physics-presets, $physics-name);

  @if $physics-map == null {
    @warn "Physics preset `#{$physics-name}` not found for `#{$name}`. Falling back to `glass`.";
    $physics-name: 'glass';
    $physics-map: map.get(physics-presets.$physics-presets, 'glass');
  }

  $palette: map.get($config, 'palette');

  @if $palette == null {
    @warn "No palette provided for theme `#{$name}`. Only physics variables will be set.";
    $palette: ();
  }

  $ease-base: map.get($physics-map, 'ease-base');
  $speed-base: map.get($physics-map, 'speed-base');
  $speed-fast: if($speed-base == 0s, 0s, $speed-base * 0.66);

  // Derived variables for current component contracts.
  $compat-physics: (
    'ease-base': $ease-base,
    'ease-stabilize': $ease-base,
    'ease-dematerialize': $ease-base,
    'ease-pulse': $ease-base,
    'ease-snap': $ease-base,
    'ease-flow': $ease-base,
    'speed-base': $speed-base,
    'speed-fast': $speed-fast
  );

  $theme-map: map.merge(map.merge($physics-map, $compat-physics), $palette);

  $selector: if($name == 'default', ':root', "[data-atmosphere='#{$name}']");
  $physics-selector: "#{$selector}[data-physics='#{$physics-name}']";

  #{$selector},
  #{$physics-selector} {
    color-scheme: if(map.get($config, 'type') == 'light', light, dark);

    @each $key, $value in $theme-map {
      --#{$key}: #{$value};
    }
  }
}
