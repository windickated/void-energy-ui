/*
 * ROLE: Physics mixin library.
 * RESPONSIBILITY: Encapsulates Glass Physics surfaces, photonic text effects, and motion utilities for reuse across the Triad Engine.
 */

@use 'variables' as *;
@use 'functions' as *;

// ==========================================================================
// MIXINS (The Physics Engine)
// ==========================================================================

// ==========================================================================
// 1. SURFACES
// ==========================================================================

// MIXIN: Floating Surface (Cards, Modals)
// Context: Positive Z-Index. Floats above the void.
// $interactive: boolean - Set to true ONLY if the element is clickable (Link/Button)
@mixin glass-float($interactive: false) {
  // 1. TEXTURE & GEOMETRY
  // Now uses the variable injected by the preset
  background: var(--surface-bg);
  border-radius: var(--radius-base);
  border-style: solid;
  border-width: var(--physics-border-width);

  // 2. LIGHTING (Directional vs Uniform is now handled by these vars)
  border-top-color: var(--surface-border-top);
  border-bottom-color: var(--surface-border-side);
  border-left-color: var(--surface-border-side);
  border-right-color: var(--surface-border-side);

  // SHADOW: Scaled by --optics-shadow-mult
  box-shadow: 0 4px 16px
    color-mix(
      in srgb,
      black calc(0.5 * var(--optics-shadow-mult) * 100%),
      transparent
    );

  // 3. BLUR
  @supports (backdrop-filter: blur(1px)) {
    backdrop-filter: blur(var(--physics-blur));
    -webkit-backdrop-filter: blur(var(--physics-blur));
  }

  // 4. MOTION
  transition:
    transform var(--speed-base) var(--ease-stabilize),
    border-color var(--speed-base) var(--ease-snap),
    background-color var(--speed-base) var(--ease-flow),
    box-shadow var(--speed-base) var(--ease-snap);

  // 5. INTERACTION
  @media (hover: hover) {
    &:hover {
      @if $interactive {
        // Variable-driven motion (Retro = none, Glass = -2px)
        transform: var(--hover-transform);
        border-color: optics-alpha(
          var(--energy-primary),
          var(--base-glow-opacity),
          // <--- CONNECTED HERE
          '--optics-glow-mult'
        );

        // HOVER SHADOW & GLOW
        // If mode=light, the colored glow (2nd part) vanishes because mult is 0.
        box-shadow:
          var(--hover-shadow),
          0
            0
            15px
            optics-alpha(
              var(--energy-primary),
              calc(var(--base-glow-opacity) * 0.8),
              // Scale relative to base
              '--optics-glow-mult'
            );
      }
    }
  }
}

// MIXIN: Sunk Surface (Inputs, Sidebars)
// Context: Negative Z-Index. Carved into the void.
@mixin glass-sunk {
  background: var(--bg-sink);

  @supports (backdrop-filter: blur(1px)) {
    backdrop-filter: blur(var(--physics-blur));
    -webkit-backdrop-filter: blur(var(--physics-blur));
  }

  // Uniform borders for sunk items
  border: var(--physics-border-width) solid var(--border-shadow);
  border-radius: var(--radius-base);

  // Inset shadow is subtle, keep it simple but scale it
  box-shadow: inset 0 2px 8px
    color-mix(
      in srgb,
      black
        calc(
          var(--base-shadow-opacity) * 0.4 * var(--optics-shadow-mult) * 100%
        ),
      transparent
    );
  color: var(--text-main);

  transition:
    border-color var(--speed-fast) var(--ease-snap),
    box-shadow var(--speed-fast) var(--ease-snap),
    outline var(--speed-fast) var(--ease-snap);

  &:focus-visible {
    border-color: var(--energy-primary);
    // Focus glow - obedient to optics
    box-shadow:
      inset 0 2px 8px
        color-mix(
          in srgb,
          black calc(0.5 * var(--optics-shadow-mult) * 100%),
          transparent
        ),
      0 0 10px optics-alpha(var(--energy-primary), 0.6, '--optics-glow-mult');
  }
}

// ==========================================================================
// 2. TYPOGRAPHY & ENERGY
// ==========================================================================

// MIXIN: Neon Text Glow
@mixin text-glow($color: var(--energy-primary)) {
  color: $color;
  // If optics-text-glow is 0 (Light Mode), shadow becomes transparent.
  text-shadow: 0 0 15px optics-alpha($color, 0.6, '--optics-text-glow');
}

// MIXIN: The "Gemini Laser" Structure
@mixin gemini-laser {
  position: relative;
  isolation: isolate; // Force stacking context on the button itself
  background: transparent;
  border: none;
  overflow: hidden;
  z-index: z('base');
  color: var(--text-main);

  // Parent radius clips the beam and keeps the gradient contained.
  border-radius: 999px; // Pill Shape

  // 1. THE ROTATING BEAM (The Gradient)
  &::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 500%;
    height: 500%;
    border-radius: 50%;

    // The "Tail" Effect Gradient
    background: conic-gradient(
      from 0deg,
      transparent 0deg,
      var(--energy-secondary) 100deg,
      var(--energy-primary) 160deg,
      var(--energy-primary) 200deg,
      var(--energy-secondary) 260deg,
      transparent 360deg
    );

    transition: background-color var(--speed-base) var(--ease-flow);

    will-change: transform;
    transform: translate(-50%, -50%);
    animation: rotate-laser 4s linear infinite;
    z-index: -2;
    opacity: 1;

    // Retro physics override: segmented radar sweep.
    @at-root :where([data-physics='retro']) & {
      background: conic-gradient(
        from 0deg,
        transparent 0deg,
        transparent 100deg,
        var(--energy-primary) 100deg,
        var(--energy-primary) 115deg,
        transparent 115deg,
        transparent 125deg,
        var(--energy-primary) 125deg,
        var(--energy-primary) 150deg,
        transparent 150deg,
        transparent 160deg,
        var(--energy-primary) 160deg,
        var(--energy-primary) 240deg,
        transparent 240deg,
        transparent 360deg
      );
      // Slight transparency echoes CRT phosphor.
      opacity: 0.8;
      // Sharp stepping for retro feel.
      animation-timing-function: steps(64);
    }
  }

  // 2. THE INNER MASK (The "Solid" Button)
  &::after {
    content: '';
    position: absolute;
    inset: 2px; // The border thickness

    // Use Solid Color, NOT Glass.
    background: var(--bg-canvas);

    z-index: -1;
    border-radius: 999px; // Pill Shape
  }

  // HOVER EFFECT: SURGE (Brightness + Width)
  @media (hover: hover) {
    &:hover::before {
      background-color: var(--energy-primary);
      animation-play-state: paused;
    }

    &:hover::after {
      background: blend(var(--bg-canvas), var(--energy-primary), 6%);
    }
  }
}

// ==========================================================================
// 3. ANIMATIONS
// ==========================================================================

// MIXIN: Atmospheric Shimmer
// Usage: Include in any element that acts as a loading skeleton.
@mixin shimmer {
  // Wide gradient prevents visible banding during translation.
  background-size: 400% 100%;

  // Time the sweep using the physics easing.
  animation: shimmer 3s infinite linear;

  // Default Void gradient
  background-image: linear-gradient(
    90deg,
    transparent 0%,
    transparent 30%,
    alpha(var(--energy-primary), 15%) 50%,
    transparent 70%,
    transparent 100%
  );

  // Light mode override to mimic reflective ink.
  @at-root :where([data-mode='light']) & {
    background-image: linear-gradient(
      90deg,
      transparent 0%,
      transparent 30%,
      rgba(255, 255, 255, 0.6) 50%,
      transparent 70%,
      transparent 100%
    );
  }

  // Terminal override creates a scanline pulse.
  @at-root :where([data-physics='retro']) & {
    opacity: 0.5;
    background-image: linear-gradient(
      90deg,
      transparent 0%,
      transparent 43%,
      var(--energy-primary) 43%,
      var(--energy-primary) 47%,
      transparent 47%,
      transparent 100%
    );
  }
}

// ==========================================================================
// 4. STATE MANAGEMENT MIXINS (Strict Protocol)
// ==========================================================================

// 1. ACTIVE STATE (Interactive)
// Use for: Toggles, Tabs, Selections.
// ⛔️ DO NOT USE: .active class
@mixin state-active {
  &[aria-pressed='true'],
  &[aria-selected='true'],
  &[aria-checked='true'],
  &[data-state='active'] {
    @content;
  }
}

// 2. OPEN STATE (Visibility)
// Use for: Dropdowns, Tooltips, Dialogs, Accordions.
// ⛔️ DO NOT USE: .show, .open classes
@mixin state-open {
  &[data-state='open'],
  &[open] {
    @content;
  }
}

// 3. LOADING STATE (Process)
// Use for: Buttons, Cards, inputs waiting for network.
// ⛔️ DO NOT USE: .loading class
@mixin state-loading {
  &[aria-busy='true'],
  &[data-status='loading'] {
    @content;
  }
}

// ==========================================================================
// 5. UTILITIES
// ==========================================================================

// HELPER: Dynamic Optical Alpha
// Calculates a color's opacity based on the Global Optical Multiplier.
// $base-opacity: 0.5 (50%)
@function optics-alpha($color, $base-opacity, $mult-var: '--optics-glow-mult') {
  // Logic: If Multiplier is 0, we want 100% transparent.
  // We approximate this using CSS calc in the color-mix percentage.
  // Note: Standard Sass cannot compile CSS calc() inside color functions easily,
  // so we rely on native CSS variables for the multiplier interaction.

  // STRATEGY:
  // We use color-mix() to inject the optical multiplier variable into the transparency channel.
  // This allows global light/dark mode switches to instantly affect opacity without JS.

  // We will define the shadow color as a variable that changes.
  @return color-mix(
    in srgb,
    $color calc(#{$base-opacity} * var(#{$mult-var}) * 100%),
    transparent
  );
}
